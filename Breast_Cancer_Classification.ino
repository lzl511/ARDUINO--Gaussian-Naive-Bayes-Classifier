// Gaussian Naive Bayes Classifier for the Arduino Portenta H7 (Arm Cortex-M7 Core)

//
const int NumFeatures = 2;
const int NumClasses = 2;
const int NumTrainSamples = 398;
const int NumTestSamples = 171;

// Training Set
float TrainData[398][2] = {
  {0.08877, 22.04}, {0.09579, 21.95}, {0.1031, 18.34}, {0.09078, 31.59}, {0.08785, 23.58},
  {0.08437, 37.88}, {0.1125, 21.74}, {0.1077, 26.44}, {0.1073, 19.08}, {0.1148, 24.13},
  {0.07948, 26.1}, {0.1149, 23.58}, {0.08044, 21.06}, {0.09754, 16.3}, {0.0971, 27.28},
  {0.09434, 21.77}, {0.1068, 24.54}, {0.1119, 33.15}, {0.09594, 12.02}, {0.1326, 28.01},
  {0.0961, 29.02}, {0.1216, 32.82}, {0.1158, 21.4}, {0.09029, 30.41}, {0.09311, 18.41},
  {0.06995, 31.98}, {0.1061, 20.61}, {0.08801, 32.04}, {0.05263, 30.37}, {0.09427, 17.76},
  {0.08223, 40.54}, {0.1039, 22.8}, {0.1141, 24.89}, {0.06955, 15.54}, {0.106, 30.8},
  {0.09159, 37.38}, {0.08293, 17.7}, {0.1038, 34.27}, {0.1099, 16.93}, {0.08401, 27.66},
  {0.08872, 20.14}, {0.07371, 24.7}, {0.08871, 24.99}, {0.08139, 23.84}, {0.07944, 22.46},
  {0.08306, 22.06}, {0.117, 31.48}, {0.09723, 24.9}, {0.1063, 25.8}, {0.09688, 22.94},
  {0.1001, 26.06}, {0.09087, 27.87}, {0.1071, 18.32}, {0.09721, 25.27}, {0.09968, 23.4},
  {0.112, 26.39}, {0.0943, 31.39}, {0.09906, 16.9}, {0.08515, 31.55}, {0.1371, 17.84},
  {0.112, 27.65}, {0.115, 26.24}, {0.0907, 30.28}, {0.09823, 30.36}, {0.1012, 22.88},
  {0.09934, 24.82}, {0.1121, 31.56}, {0.1172, 33.39}, {0.115, 19.62}, {0.1075, 23.17},
  {0.09667, 17.48}, {0.107, 29.46}, {0.1061, 22.84}, {0.1054, 25.78}, {0.1162, 32.94},
  {0.09831, 28.45}, {0.08511, 20.45}, {0.09401, 28.18}, {0.07937, 21.7}, {0.092, 25.84},
  {0.08794, 16.4}, {0.1008, 25.09}, {0.07551, 27.01}, {0.09495, 19.58}, {0.06883, 33.75},
  {0.08331, 35.46}, {0.09198, 16.93}, {0.08684, 28.01}, {0.08605, 27.29}, {0.09989, 23.31},
  {0.08739, 16.15}, {0.1099, 21.32}, {0.08749, 23.5}, {0.09055, 33.37}, {0.1141, 32.68},
  {0.08682, 31.71}, {0.101, 30.44}, {0.1115, 25.11}, {0.07991, 26.42}, {0.08117, 28.94},
  {0.08275, 32.29}, {0.08162, 30.25}, {0.09516, 21.74}, {0.08654, 25.22}, {0.07517, 35.63},
  {0.08511, 26.43}, {0.09289, 28.87}, {0.09831, 19.76}, {0.1063, 49.54}, {0.1049, 32.33},
  {0.0876, 17.7}, {0.08473, 27.27}, {0.1096, 24.17}, {0.09009, 26.58}, {0.09773, 27.21},
  {0.09929, 33.17}, {0.1085, 30.76}, {0.07431, 24.77}, {0.09684, 32.07}, {0.08974, 29.11},
  {0.1084, 31.37}, {0.1037, 21.47}, {0.1033, 19.9}, {0.1128, 21.59}, {0.1167, 21.43},
  {0.09882, 19.48}, {0.1007, 19.35}, {0.1034, 39.34}, {0.07557, 20.21}, {0.09639, 22.02},
  {0.08455, 34.12}, {0.1074, 22.44}, {0.08261, 21.33}, {0.08772, 30.5}, {0.1218, 24.37},
  {0.0808, 19.59}, {0.104, 27.26}, {0.1018, 30.93}, {0.08451, 23.07}, {0.1043, 14.2},
  {0.1051, 17.13}, {0.08968, 25.84}, {0.1039, 24.23}, {0.09774, 21.39}, {0.09947, 27.57},
  {0.1008, 31.68}, {0.08474, 23.41}, {0.1022, 25.94}, {0.1106, 29.66}, {0.09996, 15.65},
  {0.1122, 22.75}, {0.09592, 27.96}, {0.08192, 31.45}, {0.07926, 20.37}, {0.1323, 41.85},
  {0.09383, 28.64}, {0.09425, 23.64}, {0.08668, 31.89}, {0.1024, 15.66}, {0.08355, 26.17},
  {0.1049, 29.51}, {0.1054, 33.21}, {0.1065, 18.91}, {0.1164, 15.77}, {0.1088, 30.15},
  {0.08924, 20.54}, {0.1194, 20.74}, {0.1001, 21.84}, {0.07474, 31.62}, {0.111, 26.4},
  {0.09428, 35.59}, {0.09048, 29.87}, {0.08999, 27.24}, {0.08546, 26.98}, {0.09797, 34.66},
  {0.09462, 16.91}, {0.09081, 33.17}, {0.1142, 29.26}, {0.1142, 18.47}, {0.07685, 23.19},
  {0.07372, 16.36}, {0.1015, 24.22}, {0.1092, 26.76}, {0.07026, 19.97}, {0.09387, 25.2},
  {0.09261, 37.16}, {0.1063, 33.62}, {0.08508, 24.02}, {0.09462, 17.07}, {0.09566, 28.26},
  {0.1068, 26.2}, {0.1335, 22.66}, {0.1009, 25.02}, {0.08662, 31.47}, {0.0997, 19.85},
  {0.115, 18.33}, {0.09444, 29.25}, {0.1152, 16.51}, {0.08439, 28.22}, {0.08923, 24.3},
  {0.09363, 27.1}, {0.09997, 38.54}, {0.1137, 30.7}, {0.1004, 25.58}, {0.08523, 32.06},
  {0.0802, 23.03}, {0.07449, 38.3}, {0.1291, 12.49}, {0.1016, 26.02}, {0.07351, 24.61},
  {0.09446, 23.17}, {0.08182, 15.92}, {0.08491, 25.59}, {0.08928, 24.34}, {0.09514, 21.03},
  {0.1158, 27.95}, {0.1225, 18.99}, {0.08311, 24.62}, {0.1066, 25.09}, {0.06251, 29.02},
  {0.09491, 21.98}, {0.09587, 28.48}, {0.08641, 25.44}, {0.0876, 22.43}, {0.09179, 22.74},
  {0.08268, 19.64}, {0.117, 19.54}, {0.09676, 25.99}, {0.117, 31.86}, {0.09215, 28.06},
  {0.08947, 22.02}, {0.1257, 17.04}, {0.11, 15.77}, {0.1162, 27.37}, {0.0778, 41.78},
  {0.1054, 24.9}, {0.09463, 34.85}, {0.08518, 14.82}, {0.07215, 27.82}, {0.08673, 21.38},
  {0.1062, 25.59}, {0.09879, 23.02}, {0.07005, 20.07}, {0.09309, 18.}, {0.08743, 25.58},
  {0.09116, 34.37}, {0.09834, 16.18}, {0.08992, 26.19}, {0.07115, 22.75}, {0.1183, 36.33},
  {0.08206, 33.88}, {0.09746, 25.}, {0.09056, 31.69}, {0.08276, 36.}, {0.07984, 36.92},
  {0.08123, 35.74}, {0.1042, 23.13}, {0.0925, 14.1}, {0.09277, 20.2}, {0.09847, 19.52},
  {0.1066, 17.81}, {0.1046, 25.48}, {0.1134, 17.45}, {0.08876, 20.24}, {0.1131, 32.01},
  {0.09245, 41.61}, {0.1076, 22.15}, {0.0802, 22.33}, {0.1024, 33.22}, {0.102, 35.9},
  {0.103, 26.93}, {0.09057, 28.03}, {0.1007, 26.48}, {0.1048, 42.79}, {0.0695, 20.83},
  {0.09509, 34.51}, {0.08393, 23.08}, {0.07445, 28.07}, {0.1018, 28.92}, {0.08752, 31.82},
  {0.08481, 23.07}, {0.09965, 24.64}, {0.1135, 24.11}, {0.07896, 20.96}, {0.09968, 23.39},
  {0.08785, 16.92}, {0.09726, 29.33}, {0.1069, 30.73}, {0.1037, 25.23}, {0.1075, 37.18},
  {0.08583, 22.15}, {0.09492, 22.99}, {0.08694, 17.81}, {0.09172, 23.21}, {0.07793, 20.72},
  {0.09855, 23.}, {0.1044, 31.24}, {0.09752, 30.86}, {0.09687, 26.51}, {0.1139, 37.13},
  {0.1041, 28.}, {0.1237, 20.53}, {0.0988, 19.14}, {0.08671, 37.17}, {0.09384, 26.44},
  {0.1099, 29.41}, {0.0806, 22.25}, {0.08192, 31.99}, {0.09087, 24.49}, {0.08865, 26.3},
  {0.07741, 20.35}, {0.07699, 38.05}, {0.1255, 18.04}, {0.09357, 38.81}, {0.09646, 16.35},
  {0.08792, 19.2}, {0.07956, 30.04}, {0.09168, 24.56}, {0.0995, 23.53}, {0.08138, 25.47},
  {0.09246, 29.09}, {0.0978, 38.25}, {0.07969, 27.99}, {0.1096, 22.07}, {0.09463, 27.66},
  {0.1072, 19.49}, {0.1053, 19.8}, {0.1026, 26.93}, {0.08983, 17.16}, {0.09657, 35.19},
  {0.09379, 18.99}, {0.1398, 22.4}, {0.09059, 17.7}, {0.1027, 30.53}, {0.07966, 19.31},
  {0.1013, 21.19}, {0.1155, 30.5}, {0.1089, 23.22}, {0.07837, 23.73}, {0.09867, 30.88},
  {0.1049, 23.03}, {0.08853, 21.61}, {0.09779, 19.26}, {0.09816, 21.57}, {0.1167, 28.74},
  {0.06935, 28.71}, {0.1189, 28.14}, {0.1089, 26.21}, {0.1243, 24.17}, {0.086, 21.96},
  {0.09057, 25.5}, {0.08814, 26.55}, {0.08675, 25.46}, {0.06613, 28.18}, {0.09686, 25.45},
  {0.08372, 25.75}, {0.08054, 24.47}, {0.09073, 22.82}, {0.1101, 15.98}, {0.09872, 30.12},
  {0.1088, 19.67}, {0.1096, 25.53}, {0.1029, 25.8}, {0.1082, 36.71}, {0.09156, 27.15},
  {0.1075, 20.49}, {0.1109, 28.12}, {0.07838, 18.42}, {0.08875, 17.93}, {0.08931, 27.26},
  {0.1078, 23.19}, {0.07335, 28.46}, {0.07987, 20.83}, {0.1186, 40.68}, {0.1134, 21.08},
  {0.08858, 36.32}, {0.1028, 15.64}, {0.08915, 26.87}, {0.0903, 34.91}, {0.08013, 32.84},
  {0.06429, 20.65}, {0.1073, 27.98}, {0.08511, 19.71}, {0.07274, 15.82}, {0.1158, 17.72},
  {0.08677, 21.82}, {0.1243, 27.04}, {0.1082, 25.21}, {0.08369, 31.88}, {0.09768, 26.15},
  {0.09874, 27.68}, {0.1031, 20.7}, {0.07436, 20.98}, {0.1051, 25.48}, {0.09462, 19.25},
  {0.08582, 29.2}, {0.09751, 21.51}, {0.1032, 30.96}
};
int TrainLabels[398] = {
  1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1,
  1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1,
  0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1,
  1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1,
  0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1,
  1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1,
  1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1,
  0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1,
  0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 0, 0,
  0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0,
  0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 
  1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 
  1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
  0, 1, 1, 1, 1, 1, 1, 0
};

// Test Set
float TestData[171][2] = {
  {0.1028, 21.1}, {0.08123, 34.24}, {0.0904, 19.35}, {0.07376, 16.94}, {0.0924, 25.05},
  {0.07515, 18.2}, {0.08757, 22.13}, {0.1091, 26.38}, {0.1054, 22.91}, {0.09003, 19.27},
  {0.08817, 17.5}, {0.08352, 17.4}, {0.08363, 17.37}, {0.1169, 30.38}, {0.1053, 28.14},
  {0.07466, 23.89}, {0.07813, 18.26}, {0.1007, 27.0}, {0.09258, 35.64}, {0.123, 27.78},
  {0.1227, 35.34}, {0.08855, 34.69}, {0.09832, 17.24}, {0.08099, 17.6}, {0.09076, 20.79},
  {0.1278, 23.75}, {0.1035, 24.57}, {0.1109, 31.64}, {0.08477, 27.49}, {0.103, 30.36},
  {0.08713, 26.14}, {0.09578, 24.75}, {0.1122, 33.47}, {0.09898, 34.49}, {0.0944, 27.26},
  {0.1102, 32.16}, {0.1447, 23.99}, {0.1092, 26.0}, {0.08388, 28.39}, {0.0842, 45.41},
  {0.1007, 26.84}, {0.1215, 32.72}, {0.1273, 30.73}, {0.08313, 28.46}, {0.0832, 36.91},
  {0.09231, 24.04}, {0.08043, 26.34}, {0.1186, 21.4}, {0.0915, 26.37}, {0.1064, 34.01},
  {0.09883, 20.43}, {0.09597, 32.82}, {0.07963, 15.73}, {0.12, 34.01}, {0.08472, 17.58},
  {0.1197, 32.09}, {0.09742, 31.03}, {0.08142, 23.31}, {0.07941, 22.0}, {0.08597, 12.87},
  {0.108, 29.43}, {0.09342, 23.87}, {0.115, 18.16}, {0.1059, 27.2}, {0.1005, 26.83},
  {0.08302, 20.21}, {0.07721, 19.23}, {0.1184, 17.33}, {0.08445, 23.6}, {0.07355, 22.35},
  {0.08402, 27.83}, {0.1082, 24.85}, {0.1141, 33.48}, {0.09136, 24.38}, {0.1178, 39.42},
  {0.09933, 25.47}, {0.1025, 30.29}, {0.1012, 28.68}, {0.1036, 18.45}, {0.08151, 20.29},
  {0.116, 29.41}, {0.0974, 29.94}, {0.1044, 31.56}, {0.1286, 31.72}, {0.1005, 19.93},
  {0.09984, 19.68}, {0.1132, 18.24}, {0.1036, 25.41}, {0.09405, 29.72}, {0.1133, 25.07},
  {0.07683, 22.25}, {0.08682, 16.85}, {0.08588, 26.36}, {0.09916, 25.63}, {0.08365, 18.93},
  {0.08772, 25.05}, {0.08837, 31.73}, {0.06828, 21.8}, {0.08386, 27.06}, {0.1026, 23.05},
  {0.1016, 28.81}, {0.0926, 36.27}, {0.08098, 30.92}, {0.09831, 30.88}, {0.09267, 21.18},
  {0.0784, 31.67}, {0.09138, 17.04}, {0.09905, 33.81}, {0.1046, 21.9}, {0.09586, 28.36},
  {0.08098, 18.22}, {0.08464, 19.16}, {0.08759, 29.15}, {0.08637, 25.72}, {0.1006, 28.07},
  {0.1175, 25.4}, {0.07561, 19.74}, {0.08791, 34.23}, {0.1089, 30.39}, {0.07497, 26.56},
  {0.1044, 27.78}, {0.09783, 15.67}, {0.1045, 20.92}, {0.06576, 25.26}, {0.07903, 31.31},
  {0.08045, 25.34}, {0.09469, 47.16}, {0.08108, 19.29}, {0.1006, 16.82}, {0.08685, 28.88},
  {0.09345, 22.46}, {0.1094, 32.85}, {0.09423, 19.05}, {0.1425, 26.5}, {0.08458, 21.58},
  {0.1, 39.16}, {0.08371, 19.31}, {0.08946, 25.62}, {0.1066, 22.65}, {0.1007, 20.86},
  {0.09714, 29.89}, {0.09401, 30.9}, {0.0909, 27.84}, {0.08421, 25.82}, {0.1024, 26.29},
  {0.1236, 32.19}, {0.09524, 22.47}, {0.1003, 22.88}, {0.07818, 19.69}, {0.1634, 16.38},
  {0.08217, 25.73}, {0.09752, 15.4}, {0.09037, 20.88}, {0.09699, 24.39}, {0.09373, 15.97},
  {0.07734, 16.47}, {0.1003, 16.67}, {0.09812, 44.87}, {0.09488, 35.27}, {0.08983, 22.81},
  {0.1071, 33.82}, {0.1075, 25.16}, {0.08752, 33.33}, {0.1248, 15.38}, {0.1015, 33.58},
  {0.08284, 25.5}, {0.09384, 20.5}, {0.1002, 29.16}, {0.07618, 21.75}, {0.1165, 25.21},
  {0.1037, 28.65}
};
int TestLabels[171] = {
  1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1,
  1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1,
  0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0,
  1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0,
  0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1,
  0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0
};

//
float mean[NumClasses][NumFeatures];
float var[NumClasses][NumFeatures];
float prior[NumClasses];

//
float Gaussian(float x, float mean, float var) {
  if (var < 1e-6) var = 1e-6;
  float coeff = 1 / sqrt(2 * PI * var);
  float exponent = exp(- ((x - mean) * (x - mean)) / (2 * var));
  return coeff * exponent;
}

//
void train() {
  int classCount[NumClasses] = {0};
  float sum[NumClasses][NumFeatures] = {0};
  float sqSum[NumClasses][NumFeatures] = {0};

  for (int i = 0; i < NumTrainSamples; i++) {
    int c = TrainLabels[i];
    classCount[c]++;
    for (int f = 0; f < NumFeatures; f++) {
      float val = TrainData[i][f];
      sum[c][f] += val;
      sqSum[c][f] += val * val;
    }
  }

  for (int c = 0; c < NumClasses; c++) {
    for (int f = 0; f < NumFeatures; f++) {
      mean[c][f] = sum[c][f] / classCount[c];
      var[c][f] = sqSum[c][f] / classCount[c] - mean[c][f] * mean[c][f];
      if (var[c][f] < 1e-6) var[c][f] = 1e-6;
    }
    prior[c] = (float)classCount[c] / NumTrainSamples;
  }
}

//
int predict(float sample[]) {
  float probs[NumClasses];
  for (int c = 0; c < NumClasses; c++) {
    probs[c] = prior[c];
    for (int f = 0; f < NumFeatures; f++) {
      probs[c] *= Gaussian(sample[f], mean[c][f], var[c][f]);
    }
  }
  return (probs[0] > probs[1]) ? 0 : 1;
}

//
void runPrediction(float sample[], const char* label, int trueLabel) {
  unsigned long start = micros();
  int prediction = predict(sample);
  unsigned long end = micros();
  unsigned long elapsed = end - start;
  Serial.print(label);
  Serial.print(" predicted: ");
  Serial.print(prediction);
  Serial.print(" (true: ");
  Serial.print(trueLabel);
  Serial.print(") - Computation time: ");
  Serial.print(elapsed);
  Serial.println("us");
}

//
void setup() {
  Serial.begin(115200);
  delay(10000);
  
  //
  Serial.println("Gaussian Naive Bayes Classifier: Training...");
  train();
  Serial.println("Training Complete\n");

  //
  Serial.println("Testing Samples:");
  int truePos = 0, falseNeg = 0, falsePos = 0, trueNeg = 0;
  for (int i = 0; i < NumTestSamples; i++) {
    char label[20];
    sprintf(label, "Sample %d", i + 1);
    int prediction = predict(TestData[i]);
    runPrediction(TestData[i], label, TestLabels[i]);
    if (TestLabels[i] == 1 && prediction == 1) truePos++;
    else if (TestLabels[i] == 1 && prediction == 0) falseNeg++;
    else if (TestLabels[i] == 0 && prediction == 1) falsePos++;
    else if (TestLabels[i] == 0 && prediction == 0) trueNeg++;
  }

  //
  Serial.println("\nConfusion Matrix:");
  Serial.println("Predicted   |   0   |   1   ");
  Serial.println("   True   ");
  Serial.print("     0      |  "); Serial.print(trueNeg); Serial.print("   |  "); Serial.println(falsePos);
  Serial.print("     1      |  "); Serial.print(falseNeg); Serial.print("   |  "); Serial.println(truePos);
}

//
void loop() {
}